# Official framework image. Look for the different tagged releases at: https://hub.docker.com/r/library/node/tags/
variables:
  CONFIG_PACKAGE_NAME: sif-core
  RUSH_PARALLELISM: 8
  APP_CONFIG_DIR: common/build/configdir
  BRANCH: main

.staging-variables: &staging-variables
  ENVIRONMENT: staging
  AWS_REGION: us-west-2

.prod-variables: &prod-variables
  ENVIRONMENT: production
  AWS_REGION: us-west-2

.milestone-variables: &milestone-variables
  ENVIRONMENT: staging
  AWS_REGION: us-east-2

.load-test-variables: &load-test-variables
  ENVIRONMENT: staging
  AWS_REGION: us-east-2

.main-run-condition: &main-run-condition
  - if: ($CI_COMMIT_BRANCH == "main" && $CI_COMMIT_MESSAGE != /.*\[skip ci\].*/)

.milestone-run-condition: &milestone-run-condition
  - if: ($CI_COMMIT_BRANCH =~ /milestone.*/ && $CI_COMMIT_MESSAGE != /.*\[skip ci\].*/)

.load-test-run-condition: &load-test-run-condition
  - if: ($CI_COMMIT_BRANCH == "main" && $PIPELINE_TYPE=="load-test")

.branch-run-condition: &branch-run-condition
  - if: ($CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_BRANCH != "main" && $CI_COMMIT_BRANCH !~ /milestone.*/)

.branch-run-integration-condition: &branch-run-integration-condition
  - if: ($CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH != "main" && $ENVIRONMENT != null && $AWS_REGION != null && $CLEANUP == null)

.branch-run-cleanup-condition: &branch-run-cleanup-condition
  - if: ($CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH != "main" && $ENVIRONMENT != null && $AWS_REGION != null && $CLEANUP == "true")

.common-build-steps: &common-build-steps # install dependencies
  - pushd ${CI_PROJECT_DIR}/typescript/packages
  - rush update
  - rush build
  - popd

.sif-mock-build-steps: &sif-mock-build-steps # install sif-mock dependencies
  - pushd ../../
  - git config --global user.name "gitlab-ci-token"
  - git config --global user.email "gitlab-ci-token"
  - git clone https://gitlab-ci-token:$CI_JOB_TOKEN@gitlab.aws.dev/wwso-cross-industry-prototyping/sif/sif-mock-data.git
  - pushd sif-mock-data
  - npm install
  - npm run build
  - node dist/referenceDataSetInput/index.js  -r 1000000 -o ${CI_PROJECT_DIR}/mock-samples # create the mock referenceDataSets
  - node dist/loadTestInput/index.js -o ${CI_PROJECT_DIR}/mock-samples -s "load_test_single" --rc 1000000 --rr 10 --er 0 # create mock pipeline input
  - popd
  - popd

.common-git-steps: &common-git-steps # set up the git credentials
  - git config --global user.name "gitlab-ci-token"
  - git config --global user.email "gitlab-ci-token"
  - git remote set-url origin https://gitlab-ci-token:$PROJECT_ACCESS_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git

.common-install-deployment-dependencies: &common-install-deployment-dependencies
  - yum update -y
  - yum install -y git tar openssl zip unzip jq python3 python3-pip
  - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && unzip -qq awscliv2.zip
  - ./aws/install && rm -rf ./aws && rm awscliv2.zip
  - curl -s -qL -o /usr/bin/jq https://github.com/jqlang/jq/releases/download/jq-1.6/jq-linux64
  - chmod +x /usr/bin/jq
  - npm install -g @microsoft/rush esbuild@0.14 aws-cdk
  - cdk --version
  - python3 -m pip install semgrep

.common-install-gitlfs: &common-install-gitlfs
  - yum install -y amazon-linux-extras
  - amazon-linux-extras install epel -y
  - yum update -y
  - yum install -y git-lfs

.common-install-gitlfs: &common-install-gitlfs
  - yum install -y amazon-linux-extras
  - amazon-linux-extras install epel -y
  - yum update -y
  - yum install -y git-lfs

.common-install-java-dependencies: &common-install-java-dependencies
  - yum update -y
  - yum install -y git tar zip unzip jq curl openssl gcc-c++ make java-17-amazon-corretto-devel
  - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && unzip -qq awscliv2.zip
  - ./aws/install && rm -rf ./aws && rm awscliv2.zip
  - curl -s -qL -o /usr/bin/jq https://github.com/jqlang/jq/releases/download/jq-1.6/jq-linux64
  - chmod +x /usr/bin/jq
  - npm install -g @microsoft/rush esbuild@0.14 aws-cdk@2.87.0
  - cdk --version
  - java --version
  - curl "https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.8.6/apache-maven-3.8.6-bin.tar.gz" -o "maven.tar.gz" && tar -xf maven.tar.gz -C /opt
  - ln -s /opt/apache-maven-3.8.6 /opt/maven
  - export M2_HOME=/opt/maven && export MAVEN_HOME=/opt/maven && export PATH=${M2_HOME}/bin:${PATH}
  - mvn --version

.common-artifacts: &common-artifacts
  artifacts:
    paths:
      - source/common/
      - source/infrastructure/**/build.zip
      - source/packages/**/.rush/
      - source/packages/**/dist/
      - source/packages/**/tsconfig.tsbuildinfo
      - source/packages/**/bundle.zip

stages:
  - test
  - deployStage
  - integrationTest
  - release
  - deployProd
  # stages below will only be executed in branch and not main
  - deployBranch
  - integrationTestBranch
  - destroyBranch

default:
  tags:
    - arch:amd64
    - size:large
  image:
    name: public.ecr.aws/lambda/nodejs:18
    entrypoint: [ '' ]
  before_script:
    - *common-install-deployment-dependencies

# Below is deployment step for milestone branch

build-run-docker-image-milestone:
  rules:
    - *milestone-run-condition
  stage: deployStage
  variables:
    AWS_REGION: us-east-2
    CI_REGISTRY_IMAGE: ${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/schema-migrator
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [ "" ]
  before_script:
    - echo "overriding the default before_script stage"
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"credsStore\":\"ecr-login\"}" > /kaniko/.docker/config.json
    - >-
      /kaniko/executor
      --context "${CI_PROJECT_DIR}/typescript/packages/apps/schema-migrator"
      --dockerfile "${CI_PROJECT_DIR}/typescript/packages/apps/schema-migrator/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}:latest"

test-milestone:
  rules:
    - *milestone-run-condition
  stage: test
  needs: [ ]
  script:
    - *common-git-steps
    - *common-build-steps
    - rush check
    - rush test
    - semgrep scan --config auto --error

deploy-platform-milestone:
  image:
    name: public.ecr.aws/lambda/nodejs:18
    entrypoint: [ '' ]
  before_script:
    - *common-install-java-dependencies
    - *common-install-gitlfs
  rules:
    - *milestone-run-condition
  stage: deployStage
  variables:
    <<: *milestone-variables
  needs: [ 'test-milestone' ]
  script:
    - *common-build-steps
    - pushd infrastructure/platform
    - cdk deploy -c repositoryName=schema-migrator -c repositoryArn=arn:aws:ecr:${AWS_REGION}:${ACCOUNT_ID}:repository/schema-migrator -c includeCaml=true -c imageTag=latest -c rdsConcurrencyLimit=10 -c deleteBucket=true -c clusterDeletionProtection=false  -c environment=$ENVIRONMENT  --require-approval never --concurrency=5 --r $AWS_CREDS_TARGET_ROLE
    - popd

deploy-tenant-milestone:
  image:
    name: public.ecr.aws/lambda/nodejs:18
    entrypoint: [ '' ]
  before_script:
    - *common-install-java-dependencies
  rules:
    - *milestone-run-condition
  stage: deployStage
  variables:
    <<: *milestone-variables
  needs: [ 'deploy-platform-milestone' ]
  script:
    - *common-build-steps
    - pushd infrastructure/tenant
    - cdk synth -c includeCaml=true -c deleteBucket=true -c auditFileProcessingTime=1 -c enableDeleteResource=true -c tenantId=$TENANT_ID -c environment=$ENVIRONMENT -c administratorEmail=$ADMINISTRATOR_EMAIL -c outgoingTenantPaths=$TENANT_ID-shared:/shared --require-approval never --concurrency=5 --r $AWS_CREDS_TARGET_ROLE --all
    - cdk deploy --app cdk.out -c includeCaml=true -c deleteBucket=true -c auditFileProcessingTime=1 -c enableDeleteResource=true -c tenantId=$TENANT_ID -c environment=$ENVIRONMENT -c administratorEmail=$ADMINISTRATOR_EMAIL -c outgoingTenantPaths=$TENANT_ID-shared:/shared --require-approval never --concurrency=5  --r $AWS_CREDS_TARGET_ROLE --all
    - cdk synth -c deleteBucket=true -c auditFileProcessingTime=1 -c enableDeleteResource=true -c tenantId=$TENANT_ID-shared -c environment=$ENVIRONMENT -c administratorEmail=$ADMINISTRATOR_EMAIL -c externallySharedGroupIds=/shared --require-approval never --r $AWS_CREDS_TARGET_ROLE  --concurrency=5  --all
    - cdk deploy --app cdk.out -c deleteBucket=true -c auditFileProcessingTime=1 -c enableDeleteResource=true -c tenantId=$TENANT_ID-shared -c environment=$ENVIRONMENT -c administratorEmail=$ADMINISTRATOR_EMAIL -c externallySharedGroupIds=/shared --require-approval never --concurrency=5  --r $AWS_CREDS_TARGET_ROLE --all
    - popd

integrationTest-milestone-accessManagement:
  rules:
    - *milestone-run-condition
  stage: integrationTest
  variables:
    <<: *milestone-variables
  needs: [ 'deploy-tenant-milestone' ]
  script:
    - *common-build-steps
    - pushd infrastructure/tenant
    - source ./src/utils/build.sh $TENANT_ID $ENVIRONMENT $TENANT_ID-shared
    - aws cognito-idp admin-set-user-password --user-pool-id $COGNITO_USER_POOL_ID --username $ADMINISTRATOR_EMAIL --password $ADMIN_USER_PASSWORD --permanent
    - popd
    - pushd typescript/packages/integrationTests
    - npm run build && npx cucumber-js dist/features/* --tags @accessManagement
    - popd

integrationTest-milestone-worker-1:
  rules:
    - *milestone-run-condition
  stage: integrationTest
  variables:
    <<: *milestone-variables
  needs: [ 'integrationTest-milestone-accessManagement' ]
  script:
    - *common-build-steps
    - pushd infrastructure/tenant
    - source ./src/utils/build.sh $TENANT_ID $ENVIRONMENT $TENANT_ID-shared
    - aws cognito-idp admin-set-user-password --user-pool-id $COGNITO_USER_POOL_ID --username $ADMINISTRATOR_EMAIL --password $ADMIN_USER_PASSWORD --permanent
    - popd
    - pushd typescript/packages/integrationTests
    - npm run build && npx concurrently "npx cucumber-js dist/features/* --tags @calculations" "npx cucumber-js dist/features/* --tags @impacts" "npx cucumber-js dist/features/* --tags @referenceDataSets" "npx cucumber-js dist/features/* --tags @pipelines"
    - popd


integrationTest-milestone-worker-2:
  rules:
    - *milestone-run-condition
  stage: integrationTest
  variables:
    <<: *milestone-variables
  needs: [ 'integrationTest-milestone-accessManagement' ]
  script:
    - *common-build-steps
    # set up the correct cleanrooms membership id
    - export CLEANROOMS_MEMBERSHIP_ID=$CLEANROOMS_MEMBERSHIP_ID_MILESTONE
    - pushd infrastructure/tenant
    - source ./src/utils/build.sh $TENANT_ID $ENVIRONMENT $TENANT_ID-shared
    - aws cognito-idp admin-set-user-password --user-pool-id $COGNITO_USER_POOL_ID --username $ADMINISTRATOR_EMAIL --password $ADMIN_USER_PASSWORD --permanent
    - popd
    - pushd typescript/packages/integrationTests
    - npm run build && npx concurrently "npx cucumber-js dist/features/* --tags @pipelineProcessor" "npx cucumber-js dist/features/* --tags @endToEnd"
    - popd

# Below is deployment step for main branch
build-run-docker-image:
  rules:
    - *main-run-condition
  stage: deployStage
  variables:
    AWS_REGION: us-west-2
    CI_REGISTRY_IMAGE: ${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/schema-migrator
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [ "" ]
  before_script:
    - echo "overriding the default before_script stage"
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"credsStore\":\"ecr-login\"}" > /kaniko/.docker/config.json
    - >-
      /kaniko/executor
      --context "${CI_PROJECT_DIR}/typescript/packages/apps/schema-migrator"
      --dockerfile "${CI_PROJECT_DIR}/typescript/packages/apps/schema-migrator/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}:latest"

test:
  rules:
    - *main-run-condition
  stage: test
  needs: [ ]
  script:
    - *common-git-steps
    - bash -c cicd/increment_version.bash
    - *common-build-steps
    - rush check
    - rush test
    - semgrep scan --config auto --error

deploy-platform:
  image:
    name: public.ecr.aws/lambda/nodejs:18
    entrypoint: [ '' ]
  before_script:
    - *common-install-java-dependencies
    - *common-install-gitlfs
  rules:
    - *main-run-condition
  stage: deployStage
  variables:
    <<: *staging-variables
  script:
    - *common-build-steps
    - pushd infrastructure/platform
    - cdk deploy -c repositoryName=schema-migrator -c includeCaml=true -c repositoryArn=arn:aws:ecr:${AWS_REGION}:${ACCOUNT_ID}:repository/schema-migrator -c imageTag=latest -c rdsConcurrencyLimit=10 -c deleteBucket=true -c clusterDeletionProtection=false  -c environment=$ENVIRONMENT  --require-approval never --concurrency=5 --r $AWS_CREDS_TARGET_ROLE
    - popd

deploy-tenant:
  image:
    name: public.ecr.aws/lambda/nodejs:18
    entrypoint: [ '' ]
  before_script:
    - *common-install-java-dependencies
  rules:
    - *main-run-condition
  stage: deployStage
  variables:
    <<: *staging-variables
  needs: [ 'deploy-platform' ]
  script:
    - *common-build-steps
    - pushd infrastructure/tenant
    - cdk synth -c deleteBucket=true -c includeCaml=true -c auditFileProcessingTime=1 -c enableDeleteResource=true -c tenantId=$TENANT_ID -c environment=$ENVIRONMENT -c administratorEmail=$ADMINISTRATOR_EMAIL -c outgoingTenantPaths=$TENANT_ID-shared:/shared --require-approval never --concurrency=5 --r $AWS_CREDS_TARGET_ROLE --all
    - cdk deploy --app cdk.out -c includeCaml=true -c deleteBucket=true -c auditFileProcessingTime=1 -c enableDeleteResource=true -c tenantId=$TENANT_ID -c environment=$ENVIRONMENT -c administratorEmail=$ADMINISTRATOR_EMAIL -c outgoingTenantPaths=$TENANT_ID-shared:/shared --require-approval never --concurrency=5  --r $AWS_CREDS_TARGET_ROLE --all
    - cdk synth -c deleteBucket=true -c auditFileProcessingTime=1 -c enableDeleteResource=true -c tenantId=$TENANT_ID-shared -c environment=$ENVIRONMENT -c administratorEmail=$ADMINISTRATOR_EMAIL -c externallySharedGroupIds=/shared --require-approval never --r $AWS_CREDS_TARGET_ROLE  --concurrency=5  --all
    - cdk deploy --app cdk.out -c deleteBucket=true -c auditFileProcessingTime=1 -c enableDeleteResource=true -c tenantId=$TENANT_ID-shared -c environment=$ENVIRONMENT -c administratorEmail=$ADMINISTRATOR_EMAIL -c externallySharedGroupIds=/shared --require-approval never --concurrency=5  --r $AWS_CREDS_TARGET_ROLE --all
    - popd

integrationTest-main-accessManagement:
  rules:
    - *main-run-condition
  stage: integrationTest
  variables:
    <<: *staging-variables
  needs: [ 'deploy-tenant' ]
  script:
    - *common-build-steps
    - pushd infrastructure/tenant
    - source ./src/utils/build.sh $TENANT_ID $ENVIRONMENT $TENANT_ID-shared
    - aws cognito-idp admin-set-user-password --user-pool-id $COGNITO_USER_POOL_ID --username $ADMINISTRATOR_EMAIL --password $ADMIN_USER_PASSWORD --permanent
    - popd
    - pushd typescript/packages/integrationTests
    - npm run build && npx cucumber-js dist/features/* --tags @accessManagement
    - popd

integrationTest-main-worker-1:
  rules:
    - *main-run-condition
  stage: integrationTest
  variables:
    <<: *staging-variables
  needs: [ 'integrationTest-main-accessManagement' ]
  script:
    - *common-build-steps
    - pushd infrastructure/tenant
    - source ./src/utils/build.sh $TENANT_ID $ENVIRONMENT $TENANT_ID-shared
    - aws cognito-idp admin-set-user-password --user-pool-id $COGNITO_USER_POOL_ID --username $ADMINISTRATOR_EMAIL --password $ADMIN_USER_PASSWORD --permanent
    - popd
    - pushd typescript/packages/integrationTests
    - npm run build && npx concurrently "npx cucumber-js dist/features/* --tags @calculations" "npx cucumber-js dist/features/* --tags @impacts" "npx cucumber-js dist/features/* --tags @referenceDataSets" "npx cucumber-js dist/features/* --tags @pipelines"
    - popd

integrationTest-main-worker-2:
  rules:
    - *main-run-condition
  stage: integrationTest
  variables:
    <<: *staging-variables
  needs: [ 'integrationTest-main-accessManagement' ]
  script:
    - *common-build-steps
    - pushd infrastructure/tenant
    - source ./src/utils/build.sh $TENANT_ID $ENVIRONMENT $TENANT_ID-shared
    - aws cognito-idp admin-set-user-password --user-pool-id $COGNITO_USER_POOL_ID --username $ADMINISTRATOR_EMAIL --password $ADMIN_USER_PASSWORD --permanent
    - popd
    - pushd typescript/packages/integrationTests
    - npm run build && npx concurrently "npx cucumber-js dist/features/* --tags @pipelineProcessor" "npx cucumber-js dist/features/* --tags @endToEnd"
    - popd

release_typescript:
  rules:
    - *main-run-condition
  stage: release
  needs: [ 'integrationTest-main-worker-1','integrationTest-main-worker-2' ]
  script:
    - *common-build-steps
    - *common-git-steps
    - pwd
    - bash -c cicd/tag_repository.bash

release_java:
  before_script:
    - *common-install-java-dependencies
  rules:
    - *main-run-condition
  stage: release
  needs: [ 'integrationTest-main-worker-1','integrationTest-main-worker-2' ]
  script:
    - *common-git-steps
    - pwd
    - echo "$CI_COMMIT_BRANCH"
    - git checkout -B "$CI_COMMIT_BRANCH"
    - 'export CONNECTION_URL="scm:git:https://gitlab-ci-token:$PROJECT_ACCESS_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git"'
    - echo "CONNECTION_URL:$CONNECTION_URL"
    - pushd java/apps/calculator
    - 'export CALCULATOR_MESSAGE="release(calculator): [skip ci]"'
    - 'mvn -e se.bjurr.gitchangelog:git-changelog-maven-plugin:1.97.1:semantic-version org.apache.maven.plugins:maven-release-plugin:3.0.1:prepare --batch-mode -DdeveloperConnectionUrl="$CONNECTION_URL" -DskipTests=true -DscmCommitPrefix="$CALCULATOR_MESSAGE" -DscmDevelopmentCommitComment="$CALCULATOR_MESSAGE" -DscmReleaseCommitComment="$CALCULATOR_MESSAGE" org.apache.maven.plugins:maven-release-plugin:3.0.1:perform'
    - mvn generate-resources
    - popd
    - pushd java/apps/referencedatasets-indexer
    - 'INDEXER_MESSAGE="release(indexer): [skip ci]"'
    - 'mvn -e se.bjurr.gitchangelog:git-changelog-maven-plugin:1.97.1:semantic-version org.apache.maven.plugins:maven-release-plugin:3.0.1:prepare --batch-mode -DdeveloperConnectionUrl="$CONNECTION_URL" -DskipTests=true -DscmCommitPrefix="$INDEXER_MESSAGE"  -DscmDevelopmentCommitComment="$INDEXER_MESSAGE" -DscmReleaseCommitComment="$INDEXER_MESSAGE" org.apache.maven.plugins:maven-release-plugin:3.0.1:perform'
    - mvn generate-resources
    - popd
    - git branch --set-upstream-to=origin/$CI_COMMIT_BRANCH
    - git pull
    - git add java/apps/*
    - 'git commit -m "release: [skip ci]"'
    - git push

integrationTest-loadTest:
  rules:
    - *load-test-run-condition
  stage: integrationTest
  variables:
    <<: *load-test-variables
  script:
    - *common-build-steps
    - *sif-mock-build-steps
    - pushd infrastructure/tenant
    - source ./src/utils/build.sh $TENANT_ID $ENVIRONMENT $TENANT_ID-shared
    - aws cognito-idp admin-set-user-password --user-pool-id $COGNITO_USER_POOL_ID --username $ADMINISTRATOR_EMAIL --password $ADMIN_USER_PASSWORD --permanent
    - pwd
    - popd
    - pushd typescript/packages/integrationTests
    - export LOAD_TEST_DIRECTORY=${CI_PROJECT_DIR}/mock-samples
    - ls -lht $LOAD_TEST_DIRECTORY
    - rushx test:load
    - popd

deployCoreProd:
  image:
    name: public.ecr.aws/lambda/nodejs:18
    entrypoint: [ '' ]
  before_script:
    - *common-install-java-dependencies
  rules:
    - *main-run-condition
  stage: deployProd
  variables:
    <<: *prod-variables
  needs: [ 'release_typescript','release_java' ]
  script:
    - *common-build-steps
    - pushd infrastructure/platform
    - cdk deploy -c repositoryName=schema-migrator -c repositoryArn=arn:aws:ecr:${AWS_REGION}:${ACCOUNT_ID}:repository/schema-migrator -c imageTag=latest -c rdsConcurrencyLimit=10 -c deleteBucket=true -c clusterDeletionProtection=false  -c environment=$ENVIRONMENT  --require-approval never --concurrency=5 --r $AWS_CREDS_TARGET_ROLE
    - popd
    - pushd infrastructure/tenant
    - cdk synth -c deleteBucket=true -c auditFileProcessingTime=1 -c enableDeleteResource=true -c tenantId=$TENANT_ID -c environment=$ENVIRONMENT -c administratorEmail=$ADMINISTRATOR_EMAIL --require-approval never  --r $AWS_CREDS_TARGET_ROLE  --concurrency=5  --all
    - cdk deploy --app cdk.out -c deleteBucket=true -c auditFileProcessingTime=1 -c enableDeleteResource=true -c tenantId=$TENANT_ID -c environment=$ENVIRONMENT -c administratorEmail=$ADMINISTRATOR_EMAIL --all --require-approval never --concurrency=5  --r $AWS_CREDS_TARGET_ROLE
    - popd
    - *common-git-steps
    - bash -c cicd/tag_repository.bash

# Below actions are only executed in branches other than main
branchTest:
  rules:
    - *branch-run-condition
  stage: test
  script:
    # do not run rush change if the target is not main or if its dependabot related change
    - if [[ "$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME" != dependabot* &&  "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME" == "main" ]] ; then rush change --verify; fi;
    - *common-build-steps
    - rush check
    - rush test
    - semgrep scan --config auto --error

branchTestCalculator:
  image:
    name: public.ecr.aws/lambda/nodejs:18
    entrypoint: [ '' ]
  before_script:
    - *common-install-java-dependencies
  rules:
    - *branch-run-condition
  stage: test
  script:
    - cd java/apps/calculator
    - mvn clean install -X

branchTestIndexer:
  image:
    name: public.ecr.aws/lambda/nodejs:18
    entrypoint: [ '' ]
  before_script:
    - *common-install-java-dependencies
  rules:
    - *branch-run-condition
  stage: test
  script:
    - cd java/apps/referencedatasets-indexer
    - mvn clean install -X

deployBranch:
  stage: deployBranch
  rules:
    - *branch-run-integration-condition
  script:
    - echo "run deploy branch"
    - *common-build-steps
    - pushd packages/infrastructure/platform
    - cdk deploy -c deleteBucket=true -c clusterDeletionProtection=false  -c environment=$ENVIRONMENT  --require-approval never --concurrency=5 --r $AWS_CREDS_TARGET_ROLE
    - popd
    - pushd packages/infrastructure/tenant
    - cdk deploy -c auditFileProcessingTime=1 -c enableDeleteResource=true  -c deleteBucket=true -c tenantId=$TENANT_ID -c environment=$ENVIRONMENT -c administratorEmail=$ADMINISTRATOR_EMAIL -c outgoingTenantPaths=$TENANT_ID-shared:/shared --require-approval never --concurrency=5  --r $AWS_CREDS_TARGET_ROLE --all
    - cdk deploy -c auditFileProcessingTime=1 -c enableDeleteResource=true  -c deleteBucket=true -c tenantId=$TENANT_ID-shared -c environment=$ENVIRONMENT -c administratorEmail=$ADMINISTRATOR_EMAIL -c externallySharedGroupIds=/shared --require-approval never --concurrency=5  --r $AWS_CREDS_TARGET_ROLE --all
    - popd

integrationTestBranch:
  rules:
    - *branch-run-integration-condition
  stage: integrationTestBranch
  script:
    - *common-build-steps
    - pushd packages/infrastructure/tenant
    - export AWS_DEFAULT_REGION=$AWS_REGION
    - source ./src/utils/build.sh $TENANT_ID $ENVIRONMENT $TENANT_ID-shared
    - aws cognito-idp admin-set-user-password --user-pool-id $COGNITO_USER_POOL_ID --username $ADMINISTRATOR_EMAIL --password $ADMIN_USER_PASSWORD --permanent
    - popd
    - pushd packages/integrationTests
    - rushx test:integration
    - popd

destroyBranch:
  stage: destroyBranch
  rules:
    - *branch-run-cleanup-condition
  script:
    - *common-build-steps
    - pushd packages/infrastructure/platform
    - cdk destroy -c deleteBucket=true -c clusterDeletionProtection=false  -c environment=$ENVIRONMENT  --force --require-approval never --concurrency=5 --r $AWS_CREDS_TARGET_ROLE
    - popd
    - pushd packages/infrastructure/tenant
    - cdk destroy -c deleteBucket=true -c enableDeleteResource=true -c tenantId=$TENANT_ID -c environment=$ENVIRONMENT -c administratorEmail=$ADMINISTRATOR_EMAIL --require-approval never --force --concurrency=5  --r $AWS_CREDS_TARGET_ROLE --all
    - cdk destroy -c deleteBucket=true -c enableDeleteResource=true -c tenantId=$TENANT_ID-shared -c environment=$ENVIRONMENT -c administratorEmail=$ADMINISTRATOR_EMAIL --require-approval never --force --concurrency=5  --r $AWS_CREDS_TARGET_ROLE --all
    - popd



